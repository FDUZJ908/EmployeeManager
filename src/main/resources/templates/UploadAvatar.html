<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xml:lang="ko"
      lang="ko">
<head>
    <title>上传头像</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link href="/css/mystyle.css" rel="stylesheet" type="text/css" media="all"/>
    <script src="/js/jquery-3.2.1.js"></script>

    <link rel="stylesheet" href="../css/jquery.Jcrop.min.css">
    <link rel="stylesheet" href="../css/jquery.Jcrop.css">
    <script src="/js/jquery.Jcrop.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.Jcrop.min.js"></script>
    <script src="/js/jquery.color.js"></script>
    <script src="/js/html2canvas.js"></script>


</head>
<body>

<div id="avatarDiv" style="height:60%;width:100%;background:#fff;position:relative;">
    <img id="avatar"  th:src="${avatarURL}" style="position:absolute;top:0;left:0;right:0;bottom:0;margin:auto;height:auto;width:auto;max-height:100%;max-width:100%;">
</div>


<div style="height: 10%;margin-top:20%;">
    <button id="avatarSubmit"  style="width:300px;height:100px;display:block;font-size:3em;margin:auto;color: rgb(255,255,255);background-color: rgb(80,119,170);">确定更改</button>
</div>

<div style="height: 10%;margin:auto;">
    <form method="post" enctype="multipart/form-data" id="avatarForm">
        <div class="select-ava">
            <input type="file" accept="image/*" name="file" id="file" onchange="changeFile()" />
            <label for="file" id="att" style="font-size:3em;color:rgb(80,119,170);">选择头像
            </label>
        </div>

        <input type="hidden" id="x" name="x">
        <input type="hidden" id="y" name="y">
        <input type="hidden" id="w" name="w">
        <input type="hidden" id="h" name="h">
        <input type="hidden" id="srcURL" name="srcURL">
        <input type="hidden" name="userID" th:value = "${userID}">
    </form>
</div>


<div id="new">
    <canvas id="iphoneTest" width="240" height="240"></canvas>
</div>



<div class="uploadProcess" id="innerDiv" style="display:none;">
    <p>正在提交头像...</p>
</div>


<script th:inline="javascript">
	/*<![CDATA[*/
	function html2image() {
	var source = document.getElementById("avatarDiv");
	var srcURL = document.getElementById("srcURL");

	html2canvas(source, {
        onrendered: function(canvas) {
            var imageData = canvas.toDataURL(1);
            srcURL.value = imageData;

        },
    });

    }

	function checkDL () {
	var con = confirm("确认提交头像？");
        if (con == false)
            return false;
	}



    function changeFile() {
    var newSrc = $('#file').get(0).files[0];

    var reader = new FileReader();
        reader.onload = function(e){
                document.getElementById("avatar").src = this.result;
        };
    reader.readAsDataURL(newSrc);

    $("#att").text("已上传头像√");
    html2image();
    alert("success!");
    }

    function setAvatar (URL) {
    $("#avatar").remove();
    var avatarNew = document.createElement("img");
    avatarNew.setAttribute("id", "avatar");
    avatarNew.setAttribute("src", URL.toString());
    avatarNew.setAttribute("style", "position:absolute;top:0;left:0;right:0;bottom:0;margin:auto;display:block;height:auto;width:auto;max-height:100%;max-width:100%;");
    var avatarDiv = document.getElementById("avatarDiv");
    avatarDiv.appendChild(avatarNew);
    }
	/*]]>*/
</script>


<script>
	var jcropApi;
	$('#avatarDiv').Jcrop({
	allowSelect: false,
	aspectRatio: 1,
    setSelect: [ 150,150,790,790 ],
	onSelect: updateCoords
	}, function() {
	jcropApi = this;
	})
;
	function updateCoords(c){
	$('#x').val(c.x);
	$('#y').val(c.y);
	$('#w').val(c.x+640);
	$('#h').val(c.y+640);
	};

	function checkCoords(){
		if (parseInt($('#w').val())) {
		return true;
	};
	alert('请先选择头像，再提交。');
	return false;
	};

</script>

<script type="text/javascript">
    $(document).ready(function(){

        $("#avatarSubmit").click(function () {
		checkCoords();


        var result = checkDL();

        if (result == false)
            return false;

        var avatarForm = document.getElementById("avatarForm");
        var formData = new FormData(avatarForm);

        $.ajax({
        url : "UploadAvatar",
        type : "POST",
        data : formData,
        // 告诉jQuery不要去处理发送的数据
        processData : false,
        // 告诉jQuery不要去设置Content-Type请求头
        contentType : false,
        beforeSend:function(){
        $("#innerDiv").fadeIn("fast");
        },
        complete : function() {
                    $("#innerDiv").fadeOut("fast");
        },
        success : function(responseMsg) {
            if(responseMsg.num == "1") {
                alert("头像上传成功！");
                alert(responseMsg.msg.toString());
                setAvatar(responseMsg.msg);
            }
            else {
            alert(responseMsg.msg.toString());
            setAvatar(responseMsg.msg);
            }
        },
        error : function(responseMsg) {
            $("#innerDiv").fadeOut("fast");
            alert("error");
        }
        });

        });
    });
</script>
</body>
</html>
